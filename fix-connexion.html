<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”§ FIX Connexion Membres</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .btn { padding: 15px 30px; margin: 10px 5px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn:hover { opacity: 0.9; }
        .result { margin: 15px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .step { background: #e9ecef; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ RÃ©solution problÃ¨me connexion membres</h1>
        
        <div class="step">
            <h3>Ã‰tape 1: Diagnostic automatique</h3>
            <button class="btn btn-primary" onclick="diagnosticComplet()">ğŸ” Lancer le diagnostic</button>
        </div>
        
        <div id="diagnostic-results"></div>
        
        <div class="step">
            <h3>Ã‰tape 2: Solution rapide</h3>
            <button class="btn btn-danger" onclick="reinitialiserDonnees()">ğŸ”„ RÃ©initialiser TOUT</button>
            <button class="btn btn-success" onclick="corrigerDonnees()">ğŸ”§ Corriger les donnÃ©es existantes</button>
        </div>
        
        <div id="fix-results"></div>
        
        <div class="step">
            <h3>Ã‰tape 3: Test final</h3>
            <button class="btn btn-success" onclick="testerConnexionMembre()">âœ… Tester connexion Membre01</button>
            <button class="btn btn-success" onclick="window.location.href='index.html'">â¡ï¸ Aller Ã  l'application</button>
        </div>
        
        <div id="test-results"></div>
    </div>
    
    <script src="app.js"></script>
    <script>
        function log(message, type, targetId) {
            const target = document.getElementById(targetId);
            const div = document.createElement('div');
            div.className = 'result ' + type;
            div.innerHTML = message;
            target.appendChild(div);
        }
        
        function diagnosticComplet() {
            const target = document.getElementById('diagnostic-results');
            target.innerHTML = '<h3>ğŸ“Š RÃ©sultats du diagnostic</h3>';
            
            try {
                // 1. VÃ©rifier app.js
                if (typeof DB_KEYS === 'undefined') {
                    log('âŒ ERREUR CRITIQUE: app.js non chargÃ©', 'error', 'diagnostic-results');
                    return;
                }
                log('âœ… app.js chargÃ© correctement', 'success', 'diagnostic-results');
                
                // 2. Initialiser les donnÃ©es
                initDefaultData();
                log('âœ… initDefaultData() exÃ©cutÃ©', 'success', 'diagnostic-results');
                
                // 3. VÃ©rifier les utilisateurs
                const users = getData(DB_KEYS.USERS);
                log('ğŸ“Š Nombre d\'utilisateurs: <strong>' + users.length + '</strong>', 'info', 'diagnostic-results');
                
                if (users.length === 0) {
                    log('âŒ PROBLÃˆME: Aucun utilisateur trouvÃ©!', 'error', 'diagnostic-results');
                    log('ğŸ‘‰ Solution: Cliquez sur "RÃ©initialiser TOUT"', 'warning', 'diagnostic-results');
                    return;
                }
                
                // 4. VÃ©rifier l'admin
                const admin = users.find(u => u.email === 'karifadoumbouya004@gmail.com');
                if (admin) {
                    log('âœ… Admin trouvÃ©: ' + admin.prenom + ' ' + admin.nom, 'success', 'diagnostic-results');
                    log('&nbsp;&nbsp;&nbsp;ğŸ“§ Email: <code>' + admin.email + '</code>', 'info', 'diagnostic-results');
                    log('&nbsp;&nbsp;&nbsp;ğŸ”‘ Password: <code>' + admin.password + '</code>', 'info', 'diagnostic-results');
                    log('&nbsp;&nbsp;&nbsp;ğŸ‘” RÃ´le: <code>' + admin.role + '</code>', 'info', 'diagnostic-results');
                } else {
                    log('âŒ Admin non trouvÃ©!', 'error', 'diagnostic-results');
                }
                
                // 5. VÃ©rifier les membres
                const membres = users.filter(u => u.email.includes('Membres'));
                log('ğŸ“Š Membres trouvÃ©s: <strong>' + membres.length + '</strong>', 'info', 'diagnostic-results');
                
                if (membres.length === 0) {
                    log('âŒ PROBLÃˆME: Aucun membre trouvÃ©!', 'error', 'diagnostic-results');
                    log('ğŸ‘‰ Solution: Cliquez sur "RÃ©initialiser TOUT"', 'warning', 'diagnostic-results');
                    return;
                }
                
                // 6. Afficher quelques membres
                log('<h4>ğŸ‘¥ Exemples de membres:</h4>', 'info', 'diagnostic-results');
                membres.slice(0, 5).forEach(m => {
                    const statutText = m.statut ? ' - Statut: ' + m.statut : ' - <span style="color:red;">Pas de statut dÃ©fini</span>';
                    log('&nbsp;&nbsp;â€¢ <strong>' + m.prenom + ' ' + m.nom + '</strong><br>' +
                        '&nbsp;&nbsp;&nbsp;&nbsp;ğŸ“§ <code>' + m.email + '</code><br>' +
                        '&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”‘ <code>' + m.password + '</code><br>' +
                        '&nbsp;&nbsp;&nbsp;&nbsp;ğŸ‘” ' + m.role + statutText, 
                        'info', 'diagnostic-results');
                });
                
                // 7. VÃ©rifier les statuts
                const sansStatut = users.filter(u => !u.statut);
                if (sansStatut.length > 0) {
                    log('âš ï¸ ATTENTION: ' + sansStatut.length + ' utilisateurs sans statut dÃ©fini', 'warning', 'diagnostic-results');
                    log('ğŸ‘‰ Solution: Cliquez sur "Corriger les donnÃ©es existantes"', 'warning', 'diagnostic-results');
                }
                
                // 8. Test de connexion factice
                const testUser = membres[0];
                log('<h4>ğŸ§ª Test de connexion (simulation):</h4>', 'info', 'diagnostic-results');
                log('Email testÃ©: <code>' + testUser.email + '</code>', 'info', 'diagnostic-results');
                log('Password testÃ©: <code>' + testUser.password + '</code>', 'info', 'diagnostic-results');
                
                const result = login(testUser.email, testUser.password);
                if (result.success) {
                    log('âœ…âœ… TEST RÃ‰USSI: La connexion fonctionne!', 'success', 'diagnostic-results');
                    log('ğŸ‘¤ ConnectÃ© en tant que: ' + currentUser.prenom + ' ' + currentUser.nom, 'success', 'diagnostic-results');
                    log('ğŸ‰ PROBLÃˆME RÃ‰SOLU! Vous pouvez maintenant utiliser l\'application.', 'success', 'diagnostic-results');
                    logout(); // Se dÃ©connecter du test
                } else {
                    log('âŒ TEST Ã‰CHOUÃ‰: ' + result.message, 'error', 'diagnostic-results');
                    log('ğŸ‘‰ Cliquez sur "Corriger les donnÃ©es" ou "RÃ©initialiser"', 'warning', 'diagnostic-results');
                }
                
            } catch (error) {
                log('âŒ ERREUR: ' + error.message, 'error', 'diagnostic-results');
                log('<pre>' + error.stack + '</pre>', 'error', 'diagnostic-results');
            }
        }
        
        function reinitialiserDonnees() {
            if (!confirm('âš ï¸ ATTENTION!\n\nCette action va:\n- Supprimer TOUTES les donnÃ©es\n- RecrÃ©er 21 utilisateurs (1 admin + 20 membres)\n- RÃ©initialiser toutes les sections\n\nContinuer?')) {
                return;
            }
            
            const target = document.getElementById('fix-results');
            target.innerHTML = '<h3>ğŸ”„ RÃ©initialisation en cours...</h3>';
            
            try {
                // Vider TOUT le localStorage
                localStorage.clear();
                log('âœ… localStorage vidÃ©', 'success', 'fix-results');
                
                // RecrÃ©er les donnÃ©es
                initDefaultData();
                log('âœ… DonnÃ©es recrÃ©Ã©es', 'success', 'fix-results');
                
                // VÃ©rifier
                const users = getData(DB_KEYS.USERS);
                log('âœ… ' + users.length + ' utilisateurs crÃ©Ã©s', 'success', 'fix-results');
                
                // VÃ©rifier les statuts
                users.forEach(u => {
                    if (!u.statut) u.statut = 'actif';
                });
                saveData(DB_KEYS.USERS, users);
                log('âœ… Statuts dÃ©finis pour tous les utilisateurs', 'success', 'fix-results');
                
                log('ğŸ‰ RÃ‰INITIALISATION TERMINÃ‰E!', 'success', 'fix-results');
                log('ğŸ‘‰ Cliquez sur "Tester connexion Membre01" pour vÃ©rifier', 'info', 'fix-results');
                
            } catch (error) {
                log('âŒ ERREUR: ' + error.message, 'error', 'fix-results');
            }
        }
        
        function corrigerDonnees() {
            const target = document.getElementById('fix-results');
            target.innerHTML = '<h3>ğŸ”§ Correction des donnÃ©es...</h3>';
            
            try {
                const users = getData(DB_KEYS.USERS);
                
                if (users.length === 0) {
                    log('âŒ Aucun utilisateur trouvÃ©. Utilisez "RÃ©initialiser TOUT" Ã  la place.', 'error', 'fix-results');
                    return;
                }
                
                let corrected = 0;
                users.forEach(u => {
                    if (!u.statut) {
                        u.statut = 'actif';
                        corrected++;
                    }
                });
                
                saveData(DB_KEYS.USERS, users);
                log('âœ… ' + corrected + ' utilisateurs corrigÃ©s', 'success', 'fix-results');
                log('âœ… Tous les utilisateurs ont maintenant un statut "actif"', 'success', 'fix-results');
                log('ğŸ‘‰ Cliquez sur "Tester connexion Membre01" pour vÃ©rifier', 'info', 'fix-results');
                
            } catch (error) {
                log('âŒ ERREUR: ' + error.message, 'error', 'fix-results');
            }
        }
        
        function testerConnexionMembre() {
            const target = document.getElementById('test-results');
            target.innerHTML = '<h3>ğŸ§ª Test de connexion...</h3>';
            
            try {
                const email = 'Membres01@entreprise.fr';
                const password = 'membre123';
                
                log('Email: <code>' + email + '</code>', 'info', 'test-results');
                log('Password: <code>' + password + '</code>', 'info', 'test-results');
                
                const users = getData(DB_KEYS.USERS);
                const user = users.find(u => u.email === email);
                
                if (!user) {
                    log('âŒ ERREUR: Utilisateur non trouvÃ© dans la base', 'error', 'test-results');
                    log('Emails disponibles:', 'info', 'test-results');
                    users.filter(u => u.email.includes('Membres')).slice(0, 5).forEach(u => {
                        log('&nbsp;&nbsp;â€¢ ' + u.email, 'info', 'test-results');
                    });
                    return;
                }
                
                log('âœ… Utilisateur trouvÃ©: ' + user.prenom + ' ' + user.nom, 'success', 'test-results');
                log('&nbsp;&nbsp;Password stockÃ©: <code>' + user.password + '</code>', 'info', 'test-results');
                log('&nbsp;&nbsp;RÃ´le: <code>' + user.role + '</code>', 'info', 'test-results');
                log('&nbsp;&nbsp;Statut: <code>' + (user.statut || 'NON DÃ‰FINI') + '</code>', 'info', 'test-results');
                
                const result = login(email, password);
                
                if (result.success) {
                    log('âœ…âœ…âœ… SUCCÃˆS! CONNEXION RÃ‰USSIE!', 'success', 'test-results');
                    log('ğŸ‘¤ ConnectÃ© en tant que: <strong>' + currentUser.prenom + ' ' + currentUser.nom + '</strong>', 'success', 'test-results');
                    log('ğŸ‘” RÃ´le: <strong>' + currentUser.role + '</strong>', 'success', 'test-results');
                    
                    if (PERMISSIONS[currentUser.role]) {
                        log('ğŸ”“ AccÃ¨s Ã  ' + PERMISSIONS[currentUser.role].length + ' pages', 'success', 'test-results');
                        log('&nbsp;&nbsp;Pages: ' + PERMISSIONS[currentUser.role].join(', '), 'info', 'test-results');
                    }
                    
                    log('<div style="margin-top: 20px; padding: 20px; background: #d4edda; border: 2px solid #28a745; border-radius: 5px; text-align: center;">' +
                        '<h2 style="color: #155724; margin: 0;">ğŸ‰ PROBLÃˆME RÃ‰SOLU!</h2>' +
                        '<p style="margin: 10px 0;">La connexion des membres fonctionne maintenant!</p>' +
                        '<button class="btn btn-success" onclick="window.location.href=\'index.html\'" style="font-size: 18px;">â¡ï¸ Aller sur l\'application</button>' +
                        '</div>', 'success', 'test-results');
                    
                    // Se dÃ©connecter du test
                    setTimeout(() => logout(), 1000);
                    
                } else {
                    log('âŒ Ã‰CHEC: ' + result.message, 'error', 'test-results');
                    
                    if (result.message.includes('bloquÃ©')) {
                        log('âš ï¸ Le compte est BLOQUÃ‰!', 'warning', 'test-results');
                        log('Solution: Connectez-vous en admin et dÃ©bloquez le compte dans "Gestion des Utilisateurs"', 'warning', 'test-results');
                    }
                }
                
            } catch (error) {
                log('âŒ ERREUR: ' + error.message, 'error', 'test-results');
                log('<pre>' + error.stack + '</pre>', 'error', 'test-results');
            }
        }
        
        // Auto-lancement au chargement
        window.onload = function() {
            setTimeout(diagnosticComplet, 500);
        };
    </script>
</body>
</html>
