<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Diagnostic Connexion</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 900px; margin: 0 auto; }
        .info { padding: 15px; margin: 10px 0; border-radius: 5px; background: #e3f2fd; border-left: 4px solid #2196f3; }
        .success { background: #d4edda; border-left-color: #28a745; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        button { padding: 12px 24px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        h2 { margin-top: 30px; color: #333; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .login-form { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px; margin: 20px 0; }
        input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>
    <h1>üîç Diagnostic de Connexion - Intranet MGS</h1>
    
    <div id="status"></div>
    
    <div>
        <h2>√âtape 1: Diagnostic rapide</h2>
        <button onclick="diagnostic()">üîç Lancer le diagnostic complet</button>
        <button class="danger" onclick="forcerReinitialisation()">üîÑ Forcer la r√©initialisation</button>
        <button class="success" onclick="window.location.href='index.html'">‚û°Ô∏è Aller √† l'application</button>
    </div>
    
    <div class="login-form">
        <h2>√âtape 2: Tester une connexion</h2>
        <input type="email" id="test-email" placeholder="Email" value="Membres01@entreprise.fr">
        <input type="password" id="test-password" placeholder="Mot de passe" value="membre123">
        <button onclick="testerConnexion()">üîê Tester cette connexion</button>
    </div>
    
    <div id="results"></div>
    
    <script src="app.js"></script>
    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            document.getElementById('results').appendChild(div);
        }
        
        function diagnostic() {
            document.getElementById('results').innerHTML = '';
            log('üîç D√©but du diagnostic...', 'info');
            
            try {
                // 1. V√©rifier que app.js est charg√©
                if (typeof DB_KEYS === 'undefined') {
                    log('‚ùå ERREUR: app.js n\'est pas charg√© correctement', 'error');
                    return;
                }
                log('‚úÖ app.js est charg√©', 'success');
                
                // 2. Initialiser les donn√©es
                initDefaultData();
                log('‚úÖ initDefaultData() ex√©cut√©', 'success');
                
                // 3. R√©cup√©rer les utilisateurs
                const users = getData(DB_KEYS.USERS);
                log('‚úÖ ' + users.length + ' utilisateurs trouv√©s', 'success');
                
                if (users.length === 0) {
                    log('‚ö†Ô∏è ATTENTION: Aucun utilisateur dans la base. Cliquez sur "Forcer la r√©initialisation"', 'warning');
                    return;
                }
                
                // 4. Afficher les utilisateurs
                log('<h3>üë• Liste des utilisateurs:</h3>', 'info');
                users.forEach((user, index) => {
                    const emoji = user.role === 'admin' ? 'üëë' : user.role === 'cadre' ? 'üíº' : user.role === 'responsable' ? 'üìã' : 'üë§';
                    log(`${emoji} <strong>${user.prenom} ${user.nom}</strong><br>
                        &nbsp;&nbsp;&nbsp;üìß Email: <code>${user.email}</code><br>
                        &nbsp;&nbsp;&nbsp;üîë Mot de passe: <code>${user.password}</code><br>
                        &nbsp;&nbsp;&nbsp;üëî R√¥le: <strong>${user.role}</strong>`, 
                        index === 0 ? 'warning' : 'info');
                });
                
                // 5. V√©rifier PERMISSIONS
                if (typeof PERMISSIONS === 'undefined') {
                    log('‚ùå ERREUR: PERMISSIONS n\'est pas d√©fini', 'error');
                } else {
                    log('‚úÖ PERMISSIONS est d√©fini', 'success');
                    log('<pre>' + JSON.stringify(PERMISSIONS, null, 2) + '</pre>', 'info');
                }
                
                // 6. V√©rifier localStorage
                const storageSize = new Blob(Object.values(localStorage)).size;
                log('üíæ Taille du localStorage: ' + (storageSize / 1024).toFixed(2) + ' KB', 'info');
                
                log('<h3>‚úÖ Diagnostic termin√©!</h3>', 'success');
                log('Vous pouvez maintenant tester une connexion ci-dessus.', 'info');
                
            } catch (error) {
                log('‚ùå ERREUR: ' + error.message, 'error');
                console.error('Erreur compl√®te:', error);
            }
        }
        
        function testerConnexion() {
            document.getElementById('status').innerHTML = '';
            
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            log('<h3>üîê Test de connexion...</h3>', 'info');
            log('üìß Email: <code>' + email + '</code><br>üîë Mot de passe: <code>' + password + '</code>', 'info');
            
            try {
                const users = getData(DB_KEYS.USERS);
                log('‚úÖ R√©cup√©ration de ' + users.length + ' utilisateurs', 'success');
                
                // Recherche manuelle
                const foundUser = users.find(u => u.email === email);
                if (!foundUser) {
                    log('‚ùå Aucun utilisateur trouv√© avec l\'email: ' + email, 'error');
                    log('‚ö†Ô∏è V√©rifiez que l\'email est exactement: <code>Membres01@entreprise.fr</code> (sensible √† la casse)', 'warning');
                    return;
                }
                
                log('‚úÖ Utilisateur trouv√©: ' + foundUser.prenom + ' ' + foundUser.nom, 'success');
                
                if (foundUser.password !== password) {
                    log('‚ùå Mot de passe incorrect', 'error');
                    log('Mot de passe attendu: <code>' + foundUser.password + '</code><br>Mot de passe fourni: <code>' + password + '</code>', 'error');
                    return;
                }
                
                log('‚úÖ Mot de passe correct', 'success');
                
                // Tester la fonction login
                const result = login(email, password);
                
                if (result.success) {
                    log('‚úÖ‚úÖ‚úÖ CONNEXION R√âUSSIE!', 'success');
                    log('üë§ Utilisateur connect√©: <strong>' + currentUser.prenom + ' ' + currentUser.nom + '</strong>', 'success');
                    log('üëî R√¥le: <strong>' + currentUser.role + '</strong>', 'success');
                    
                    if (PERMISSIONS[currentUser.role]) {
                        log('üîì Acc√®s autoris√© √† ' + PERMISSIONS[currentUser.role].length + ' pages', 'success');
                    }
                    
                    log('<h3>‚úÖ La connexion fonctionne correctement!</h3>', 'success');
                    log('Vous pouvez maintenant aller sur l\'application et vous connecter.', 'success');
                    
                    // Cr√©er un bouton pour se connecter directement
                    setTimeout(() => {
                        const statusDiv = document.getElementById('status');
                        statusDiv.innerHTML = '<div class="success" style="padding: 20px; text-align: center;"><h2>‚úÖ Connexion test√©e avec succ√®s!</h2><button class="success" onclick="allerVersApp()" style="font-size: 18px; padding: 15px 30px;">‚û°Ô∏è Se connecter sur l\'application</button></div>';
                    }, 500);
                    
                } else {
                    log('‚ùå √âchec de connexion: ' + result.message, 'error');
                }
                
            } catch (error) {
                log('‚ùå ERREUR: ' + error.message, 'error');
                console.error('Erreur compl√®te:', error);
            }
        }
        
        function forcerReinitialisation() {
            if (!confirm('‚ö†Ô∏è ATTENTION: Cette action va supprimer TOUTES les donn√©es et cr√©er de nouveaux utilisateurs.\n\n√ätes-vous s√ªr de vouloir continuer?')) {
                return;
            }
            
            document.getElementById('results').innerHTML = '';
            log('üîÑ R√©initialisation en cours...', 'warning');
            
            // Vider compl√®tement le localStorage
            localStorage.clear();
            log('‚úÖ localStorage vid√©', 'success');
            
            // Forcer la cr√©ation des donn√©es
            initDefaultData();
            log('‚úÖ Donn√©es r√©initialis√©es', 'success');
            
            // V√©rifier
            const users = getData(DB_KEYS.USERS);
            log('‚úÖ ' + users.length + ' utilisateurs cr√©√©s', 'success');
            
            log('<h3>‚úÖ R√©initialisation termin√©e!</h3>', 'success');
            log('Cliquez sur "Lancer le diagnostic complet" pour v√©rifier.', 'info');
        }
        
        function allerVersApp() {
            window.location.href = 'index.html';
        }
        
        // Auto-diagnostic au chargement
        window.onload = function() {
            document.getElementById('status').innerHTML = '<div class="info"><strong>üëã Bienvenue sur la page de diagnostic</strong><br>Cliquez sur "Lancer le diagnostic complet" pour commencer.</div>';
        };
    </script>
</body>
</html>
